{% extends "main.html" %}
{% load static %}

{% block content %}

<article>
    <div class="container-fluid">
        <div class="d-flex align-items-start gap-2 my-2">
            <a href="{% url 'Dashboard:admin-dashboard' %}" class="text-decoration-none"><h5 class="m-0 light-gray fw-medium">Home</h5></a>
            <span class="material-symbols-rounded light-gray">
                keyboard_arrow_right
                </span>
            <h5 class="m-0 light-gray fw-medium">Assessments</h5>
            <span class="material-symbols-rounded light-gray">
                keyboard_arrow_right
                </span>
            <h5 class="m-0 light-gray fw-medium">Training Evaluation</h5>
        </div>

    </div>

    <div class="article-container">
        <div class="mt-1">
            <div class="row flex-lg-row-reverse align-items-center justify-content-center">
                <div class="col-md-6 hero-image-size">
                  <img src="{% static 'images/Training-effectiveness.jpg' %}" class="d-block mx-lg-auto survey-img-banner" alt="Bootstrap Themes" loading="lazy">
                </div>
                <div class="col-md-6 px-4">
                  <h1 class="display-6 fw-bold dark-gray">Training Effectiveness Evaluation</h1>
                  <p class="dark-gray hero-description mb-3">Analyze the impact of your training programs by reviewing these evaluation results. Gain valuable insights into participant satisfaction, knowledge acquisition, and the application of learned skills in the workplace. Use this data to identify areas for improvement and optimize your training initiatives.</p>
                    <!-- Button trigger modal for new survey -->
                  <button type="button" class="custom-button mb-5" data-bs-toggle="modal" data-bs-target="#new_training">+ New Training</button>

                  <!-- Modal for New survey-->
                  <div class="modal fade" id="new_training" tabindex="-1" aria-labelledby="new_trainingLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h4 class="modal-title" id="new_trainingLabel">Create New Training</h4>
                            </div>
                            <form class="needs-validation" novalidate method="POST" action="{% url 'create-training' %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-2">
                                        <label for="training_date" class="form-label">Training Date</label>
                                        <input type="date" class="form-control" id="training_date" name="training_date" required>
                                        <div class="invalid-feedback">
                                          Please provide date of training
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label for="training_name" class="form-label">Training Title</label>
                                        <input type="text" class="form-control" id="training_name" name="training_title" required>
                                        <div class="invalid-feedback">
                                          Please provide name of training
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label for="training_obj" class="form-label">Training Objective</label>
                                        <textarea type="text" class="form-control" id="training_obj" name="training_obj" required></textarea>
                                        <div class="invalid-feedback">
                                          Please provide objective of training
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label for="training_speaker" class="form-label">Training Speaker</label>
                                        <input type="text" class="form-control" id="training_speaker" name="training_speaker" required>
                                        <div class="invalid-feedback">
                                          Please provide speaker of training
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Participants</label>
                                        <div class="card p-3">
                                            <div class="mb-2">
                                                <input type="text" class="form-control" id="searchParticipant" placeholder="Search participants" onkeyup="searchParticipants()">
                                            </div>
                                            <div class="table-container">
                                                <table id="participantTable" class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th class="participant-col1"></th>
                                                            <th class="participant-col2">ID Number</th>
                                                            <th>Name</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="training-participant">
                                                        {% for participant in participants %}
                                                            <tr>
                                                                <td class="participant-col1">
                                                                    <div class="checkbox-wrapper-46">
                                                                        <input type="checkbox" id="{{participant.idnumber}}" class="inp-cbx participant-checkbox" />
                                                                        <label for="{{participant.idnumber}}" class="cbx">
                                                                            <span>
                                                                                <svg width="12px" height="10px" viewbox="0 0 12 10">
                                                                                    <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
                                                                                </svg>
                                                                            </span>
                                                                        </label>
                                                                    </div>
                                                                </td>
                                                                <td class="participant-col2">{{participant.idnumber}}</td>
                                                                <td>{{participant.name}}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hidden input for selected participants -->
                                    <input type="hidden" name="selected_participants" id="selected_participants">
                                </div>
                                <div class="modal-footer">
                                <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="custom-button">Create</button>
                                </div>
                            </form>
                        </div>
                        </div>
                    </div>
                </div>
              </div>
          </div>
            <div class="">

                <div class="table-controls-admin">
                    <div class="d-flex gap-1">
                        <div class="InputContainer">
                            <input type="text" name="text" class="searchinput" id="searchInput" placeholder="Search" onkeyup="searchTrainingTable()">
                            <label for="searchInput" class="labelforsearch">
                            <svg viewBox="0 0 512 512" class="searchIcon"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"></path></svg>
                            </label>
                        </div>
                    </div>
                </div>

                {% if trainings %}
                <div class="table-container">
                    <table id="requestTable">
                    <thead>
                        <tr>
                        <th class="light-gray" onclick="sortTrainingType(0)">Date</th>
                        <th class="light-gray" onclick="sortTrainingType(1)">Title</th>
                        <th class="light-gray" onclick="sortTrainingType(2)">Speaker</th>
                        <th class="light-gray">State</th>
                        <th class="light-gray">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="training-table-container">
                        {% for training in trainings %}
                        <tr>
                            <td>{{training.training_date|date:"F d, Y"}}</td>
                            <td>{{training.training_title}}</td>
                            <td>{{training.training_speaker}}</td>
                            <td>
                                {% if training.is_closed %}
                                <div class="state-indicator state-close">
                                    <span class="state-dot-close"></span> CLOSED
                                </div>                                  
                                {% else %}
                                <div class="state-indicator state-close">
                                    <span class="state-dot-open"></span> OPEN
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <!-- open button -->
                                    <a href="{% url 'view-training' pk=training.id %}" class="text-decoration-none">
                                        <button type="button" class="button-light">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="#E85C0D" class="bi bi-folder2-open action-icon" viewBox="0 0 16 16" stroke="#E85C0D" stroke-width="0.5">
                                                <path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.76.56 2.311 1.184C7.985 3.648 8.48 4 9 4h4.5A1.5 1.5 0 0 1 15 5.5v.64c.57.265.94.876.856 1.546l-.64 5.124A2.5 2.5 0 0 1 12.733 15H3.266a2.5 2.5 0 0 1-2.481-2.19l-.64-5.124A1.5 1.5 0 0 1 1 6.14zM2 6h12v-.5a.5.5 0 0 0-.5-.5H9c-.964 0-1.71-.629-2.174-1.154C6.374 3.334 5.82 3 5.264 3H2.5a.5.5 0 0 0-.5.5zm-.367 1a.5.5 0 0 0-.496.562l.64 5.124A1.5 1.5 0 0 0 3.266 14h9.468a1.5 1.5 0 0 0 1.489-1.314l.64-5.124A.5.5 0 0 0 14.367 7z"/>
                                            </svg>
                                        </button>
                                    </a>

                                    <!-- cancel button -->
                                    <button  class="button-light" type="button" data-bs-toggle="modal" data-bs-target="#Delete{{training.id}}">
                                        <svg xmlns="http://www.w3.org/2000/svg"fill="#f3473b" class="bi bi-trash3-fill action-icon" viewBox="0 0 16 16">
                                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>
                                        </svg>
                                    </button>

                                    <!-- modal for deletion of training -->
                                    <div class="modal fade" id="Delete{{training.id}}" tabindex="-1" aria-labelledby="Delete{{training.id}}Label" aria-hidden="true">
                                        <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                            <h3 class="modal-title" id="Delete{{training.id}}Label">Confirm Deletion</h3>
                                            </div>
                                            <div class="modal-body">
                                                <p class="pb-2">Do you want to delete this training?</p>
                                                <div class="alert alert-danger" role="alert">
                                                    <p>Please note that deleting this training is irreversible. All training data and participant evaluations will be deleted also.</p>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
                                                <form method="POST" action="{% url 'delete-training' pk=training.id %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="delete-button">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                        </div>
                                    </div>

                                </div>  
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-filed-prf-container">
                    <div><h5 class="light-gray">You haven't created any training yet.</h5></div>
                    <img src="{% static 'images/empty-box.png' %}" alt="no data found">
                </div>
                {% endif %}
            </div>
        </div>
        
    </div>
    
</article>

<script>
    (() => {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
          form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
      
            form.classList.add('was-validated')
          }, false)
        })
      })()

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const participantCheckboxes = document.querySelectorAll('.participant-checkbox');
        const selectedParticipantsInput = document.getElementById('selected_participants');

        form.addEventListener('submit', function(e) {
            const selectedParticipants = [];
            participantCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedParticipants.push(checkbox.id);
                }
            });
            selectedParticipantsInput.value = JSON.stringify(selectedParticipants);
        });
    });

    function searchTrainingTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("requestTable");
        const rows = table.getElementsByTagName("tr");
      
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].getElementsByTagName("td");
          let shouldDisplay = false;
          for (let j = 0; j < cells.length - 1; j++) {
            if (cells[j].innerText.toLowerCase().includes(filter)) {
              shouldDisplay = true;
              break;
            }
          }
          rows[i].style.display = shouldDisplay ? "" : "none";
        }
      }
  
    function sortTrainingType(columnIndex) {
        const table = document.getElementById("requestTable");
        const rows = Array.from(table.rows).slice(1);
        const sortedRows = rows.sort((a, b) => {
          const aText = a.cells[columnIndex].innerText.toLowerCase();
          const bText = b.cells[columnIndex].innerText.toLowerCase();
          return aText.localeCompare(bText);
        });
      
        sortedRows.forEach(row => table.tBodies[0].appendChild(row));
      }

      function searchParticipants() {
        let input = document.getElementById('searchParticipant');
        let filter = input.value.toUpperCase();
        
        let table = document.getElementById('participantTable');
        let tr = table.getElementsByTagName('tr');
        
        for (let i = 1; i < tr.length; i++) {
            let tdId = tr[i].getElementsByTagName('td')[1];
            let tdName = tr[i].getElementsByTagName('td')[2];

            if (tdId || tdName) {
                let txtValueId = tdId.textContent || tdId.innerText;
                let txtValueName = tdName.textContent || tdName.innerText;
                
                if (txtValueId.toUpperCase().indexOf(filter) > -1 || txtValueName.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
    }
</script>

{% endblock content %}