{% extends "main.html" %}
{% load static %}

{% block content %}

<article>
    <div class="container-fluid">
        <div class="d-flex align-items-start gap-2 my-2">
            <a href="{% url 'Dashboard:Dashboard' %}" class="text-decoration-none">
                <h5 class="m-0 light-gray fw-medium">Home</h5>
            </a>
            <span class="material-symbols-rounded light-gray">
                keyboard_arrow_right
            </span>
            <h5 class="m-0 light-gray fw-medium">Leave Request</h5>
        </div>

    </div>

    <div class="article-container">
        <div class="mt-1">
            <div class="pt-3 pb-1">
                <h1 class="display-6 fw-bold dark-gray mb-3">Leave Request</h1>
            </div>
            <div class="row px-2">
                {% if request.user.employment_info.first.Status.name != "OJT" %}
                <!-- Available slvl yr1 -->
                <div class="col-12 col-md-3 p-1">
                    <div class="card">
                        <div class="card-body">
                            <div class=" d-flex align-items-center gap-3">
                                <h2 class="display-6 fw-bold light-gray lh-1 p-2 rounded-3" style="background-color: #eef1ff; color: #7c92ff;">{{vlcurrentyear.balances}}</h2>
                                <div>
                                    <h5 class="dark-gray fw-bold m-0">{{vlcurrentyear.leave_type}} {{vlcurrentyear.date_started|date:'Y'}}</h5>
                                    <p class="light-gray fw-medium m-0">{{vlcurrentyear.date_started|date:'F d, Y'}} - {{vlcurrentyear.date_ended|date:'Y'}}</p>
                                </div>
                            </div>

                            <div class=" d-flex align-items-center gap-3 pt-1">
                                <h2 class="display-6 fw-bold light-gray lh-1 p-2 rounded-3" style="background-color: #eef1ff; color: #7c92ff;">{{slcurrentyear.balances}}</h2>
                                <div>
                                    <h5 class="dark-gray fw-bold m-0">{{slcurrentyear.leave_type}} {{slcurrentyear.date_started|date:'Y'}}</h5>
                                    <p class="light-gray fw-medium m-0">{{slcurrentyear.date_started|date:'F d, Y'}} - {{slcurrentyear.date_ended|date:'Y'}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available slvl yr2 -->
                <div class="col-12 col-md-3 p-1">
                    <div class="card">
                        <div class="card-body">
                            <div class=" d-flex align-items-center gap-3">
                                <h2 class="display-6 fw-bold light-gray lh-1 p-2 rounded-3" style="background-color: #eef1ff; color: #7c92ff;">{{vlnextyear.balances}}</h2>
                                <div>
                                    <h5 class="dark-gray fw-bold m-0">{{vlnextyear.leave_type}} {{vlnextyear.date_started|date:'Y'}}</h5>
                                    <p class="light-gray fw-medium m-0">{{vlnextyear.date_started|date:'F d, Y'}} - {{vlnextyear.date_ended|date:'Y'}}</p>
                                </div>
                            </div>

                            <div class=" d-flex align-items-center gap-3 pt-1">
                                <h2 class="display-6 fw-bold light-gray lh-1 p-2 rounded-3" style="background-color: #eef1ff; color: #7c92ff;">{{slnextyear.balances}}</h2>
                                <div>
                                    <h5 class="dark-gray fw-bold m-0">{{slnextyear.leave_type}} {{slnextyear.date_started|date:'Y'}}</h5>
                                    <p class="light-gray fw-medium m-0">{{slnextyear.date_started|date:'F d, Y'}} - {{slnextyear.date_ended|date:'Y'}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Leave -->
                <div class="col-12 col-md-6 p-1">
                    <div class="card">
                        {% if next_upcoming_leave %}
                        <div class="card-body leave-card-container">
                            <div class="d-flex justify-content-between align-items-center p-0 m-0">
                                <h4 class="dark-gray body-title">Upcoming Leave</h4>
                                {% if next_upcoming_leave.status == "Approved" %}
                                    <img src="{% static 'images/icons/disapproved.png' %}" alt="leave disapproved" class="leave-status-icon">
                                {% elif next_upcoming_leave.status == "Disapproved" %}
                                    <img src="{% static 'images/icons/approved.png' %}" alt="leave approved" class="leave-status-icon">
                                {% else %}
                                    <img src="{% static 'images/icons/pending.png' %}" alt="leave pending" class="leave-status-icon">
                                {% endif %}
                            </div>
                            
                            <div class="">
                                <h5 class="dark-gray fw-bold" style="color: #6780ff;">{{next_upcoming_leave.days}} Days</h5>
                                <p class="light-gray body-regular m-0">{{next_upcoming_leave.leave_type}} - {{next_upcoming_leave.reason}}</p>
                                <p class="dark-gray body-text">{{next_upcoming_leave.from_date|date:'F d, Y'}} - {{next_upcoming_leave.to_date|date:'F d, Y'}}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="card-body leave-card-container align-items-center justify-content-center">
                            <h4 class="light-gray fw-medium">No Upcoming Leave</h4>
                            <img src="{% static 'images/empty-box.png' %}" alt="no upcoming leave" width="70" height="70" class="pt-2">
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!--leave history -->
                <div class="col-12 col-md-12 p-1">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h4 class="dark-gray body-title">Leave History</h4>

                                <!-- button for new request -->
                                <button type="button" class="custom-button" data-bs-toggle="modal" data-bs-target="#new_survey">+ New Request</button>

                                <!-- Modal for New leave request-->
                                <div class="modal fade" id="new_survey" tabindex="-1" aria-labelledby="new_surveyLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                        <h4 class="modal-title light-gray" id="new_surveyLabel">New Leave Request</h4>
                                        </div>
                                        <form  method="POST" action="{% url 'submit-leaverequest' %}" class="needs-validation" novalidate>
                                            {% csrf_token %}
                                            <div class="modal-body">
                                                <div class="row g-2">                                  
                                                    <div class="col-md-6 col-6">
                                                        <label for="leaveFrom" class="form-label m-0">Date From</label>
                                                        <input type="date" class="form-control body-regular dark-gray" name="leave_from" id="leaveFrom" required>
                                                        <div class="invalid-feedback">
                                                            Please specify the start date.
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-md-6 col-6">
                                                        <label for="leaveTo" class="form-label m-0">Date To</label>
                                                        <input type="date" class="form-control body-regular dark-gray" name="leave_to" id="leaveTo" required>
                                                        <div class="invalid-feedback">
                                                            Please specify the end date.
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row g-2 my-2 selection">                                  
                                                    <div class="col-md-6">
                                                        <label class="form-label dark-gray m-0" for="leave_type">Leave Type</label>
                                                        <select class="form-select body-regular dark-gray" id="leave_type" name="leave_type" required>
                                                            <option selected disabled value="">Choose...</option>
                                                            {% for leavetype in leavetypes %}
                                                                <option value="{{ leavetype.id }}">{{ leavetype.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="invalid-feedback">
                                                            Please select leave type.
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-md-6 selection">
                                                        <label class="form-label dark-gray m-0" for="durationSelect">Duration</label>
                                                        <select class="form-select body-regular dark-gray" id="durationSelect" required>
                                                            <option selected value="Full Day">Full Day</option>
                                                            <option value="Half Day" class="d-none">Half Day</option>
                                                            <option value="Under Time" class="d-none">Under Time</option>
                                                        </select>
                                                        <div class="invalid-feedback">
                                                            Please select leave duration.
                                                        </div>
                                                        <input id="underTimeInput" type="number" 
                                                               class="rounded form-control form-control-sm body-regular dark-gray form-control-undertime d-none" 
                                                               name="under_time" placeholder="Specify under-time hours">
                                                    </div>
                                                </div>

                                                <div class="card" style="background-color: #eef1ff; color: #7c92ff;">
                                                    <div class="card-body">
                                                        <div class="row">                                  
                                                            <div class="col-md-6 col-6 ">
                                                                <h6>Number of Days</h6>
                                                                <h2 class="display-6 fw-bold text-center" id="no_of_days" style="color:#9b92ff;">0</h2>
                                                                <input type="text" name="no_of_days" id="hidden_no_of_days" style="display: none">
                                                              </div>
                                                        
                                                              <div class="col-md-6 col-6">
                                                                <h6>Number of Hours</h6>
                                                                <h2 class="display-6 fw-bold text-center" id="no_of_hrs" style="color:#9b92ff;">0</h2>
                                                                <input type="text" name="no_of_hrs" id="hidden_no_of_hrs" style="display: none">
                                                              </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="selection mt-2">
                                                    <label class="form-label dark-gray m-0" for="leave_category">Category</label>
                                                    <select class="form-select body-regular dark-gray" id="leave_category" name="leave_category" required>
                                                        <option selected disabled value="">Choose...</option>
                                                    </select>
                                                    <div class="invalid-feedback">
                                                        Please select a category.
                                                    </div>
                                                </div>

                                                <div class="mt-2">
                                                    <label class="dark-gray mt-2" for="leave_reason">Reason</label>
                                                    <textarea type="text" class="form-control body-regular dark-gray" id="leave_reason" name="reason" required></textarea>
                                                    <div class="invalid-feedback">
                                                        Please provide your reason.
                                                      </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="custom-button">Submit</button>
                                            </div>
                                        </form>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            {% if requests %}
                            <div class="table-container">
                                <table id="requestTable">
                                <thead>
                                    <tr>
                                    <th class="light-gray" onclick="sortTable(0)">Leave Type</th>
                                    <th class="light-gray">Date From</th>
                                    <th class="light-gray">Date To</th>
                                    <th class="light-gray">Days</th>
                                    <th class="light-gray">Duration</th>
                                    <th class="light-gray">Reason</th>
                                    <th class="light-gray">Status</th>
                                    <th class="light-gray">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="leave-history-table">
                                    {% for request in requests %}
                                    <tr>
                                        <td id="LeaveType">{{request.leave_type}}</td>
                                        <td>{{request.from_date|date:'m-d-Y'}}</td>
                                        <td>{{request.to_date|date:'m-d-Y'}}</td>
                                        <td>{{request.days}}</td>
                                        <td>{{request.hrs}} Hrs</td>
                                        <td>{{request.reason}}</td>
                                        <td>
                                            {% if request.status == "Approved" %}
                                                <span class="status-badge status-approve">Approve</span>
                                            {% elif request.status == "Disapproved" %}
                                                <span class="status-badge status-cancel">Disapproved</span>
                                            {% else %}
                                                <span class="status-badge status-pending">On Processing</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <!-- open button -->
                                                <button type="button" class="button-light" data-bs-toggle="offcanvas" data-bs-target="#View{{request.id}}" aria-controls="View{{request.id}}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="#E85C0D" class="bi bi-folder2-open action-icon" viewBox="0 0 16 16" stroke="#E85C0D" stroke-width="0.5">
                                                        <path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.76.56 2.311 1.184C7.985 3.648 8.48 4 9 4h4.5A1.5 1.5 0 0 1 15 5.5v.64c.57.265.94.876.856 1.546l-.64 5.124A2.5 2.5 0 0 1 12.733 15H3.266a2.5 2.5 0 0 1-2.481-2.19l-.64-5.124A1.5 1.5 0 0 1 1 6.14zM2 6h12v-.5a.5.5 0 0 0-.5-.5H9c-.964 0-1.71-.629-2.174-1.154C6.374 3.334 5.82 3 5.264 3H2.5a.5.5 0 0 0-.5.5zm-.367 1a.5.5 0 0 0-.496.562l.64 5.124A1.5 1.5 0 0 0 3.266 14h9.468a1.5 1.5 0 0 0 1.489-1.314l.64-5.124A.5.5 0 0 0 14.367 7z"/>
                                                    </svg>
                                                </button>

                                                <!-- offcanvas leave view -->
                                                <div class="offcanvas offcanvas-end" style="width: 700px;" data-bs-scroll="true" tabindex="-1" id="View{{request.id}}" aria-labelledby="View{{request.id}}Label">
                                                    <div class="offcanvas-header">
                                                        <h3 class="offcanvas-title light-gray fw-bold" id="View{{request.id}}Label">Leave Details</h3>
                                                      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                                    </div>
                                                    <div class="offcanvas-body"> 
                                                      <!-- timeline -->
                                                      <div class="timeline" id="timeline{{request.id}}"></div>

                                                        <script>
                                                            async function fetchLeaveRoutingData(leaveRequestId) {
                                                                try {
                                                                    const response = await axios.get(`/Leave/api/leaverouting/${leaveRequestId}/`);
                                                                    const timelineData = response.data;
                                                                    renderTimeline(timelineData, leaveRequestId);
                                                                } catch (error) {
                                                                    console.error('Error fetching leave routing data:', error);
                                                                }
                                                            }
                                                        
                                                            function getStatusColor(status) {
                                                                switch(status.toLowerCase()) {
                                                                    case 'approved': return '#88D66C';
                                                                    case 'pending': return '#FCDE70';
                                                                    case 'waiting for approval': return '#7c92ff';
                                                                    case 'disapproved':
                                                                    case 'cancelled': return '#FF7777';
                                                                    default: return '#888888';
                                                                }
                                                            }
                                                        
                                                            function createTimelineItem(item) {
                                                                const itemElement = document.createElement('div');
                                                                itemElement.className = `timeline-item ${item.status.toLowerCase() === 'waiting for approval' ? 'current' : ''}`;
                                                                
                                                                const iconElement = document.createElement('div');
                                                                iconElement.className = 'timeline-icon';
                                                                iconElement.style.backgroundColor = getStatusColor(item.status);
                                                                
                                                                const contentElement = document.createElement('div');
                                                                contentElement.className = `timeline-content ${item.status.toLowerCase().replace(/\s/g, '')}`;
                                                                
                                                                const headerElement = document.createElement('div');
                                                                headerElement.className = 'timeline-header';
                                                                
                                                                const titleElement = document.createElement('h3');
                                                                titleElement.className = 'timeline-title';
                                                                titleElement.textContent = item.title;
                                                                
                                                                const dateElement = document.createElement('div');
                                                                dateElement.className = 'timeline-date';
                                                                
                                                                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                                                                dateElement.textContent = new Date(item.date).toLocaleDateString('en-US', dateOptions); 
                                                                
                                                                headerElement.appendChild(titleElement);
                                                                headerElement.appendChild(dateElement);
                                                                
                                                                const statusElement = document.createElement('div');
                                                                statusElement.className = 'timeline-status';
                                                                statusElement.textContent = item.status;
                                                                
                                                                contentElement.appendChild(headerElement);
                                                                contentElement.appendChild(statusElement);
                                                                
                                                                itemElement.appendChild(iconElement);
                                                                itemElement.appendChild(contentElement);
                                                                
                                                                return itemElement;
                                                            }
                                                        
                                                            function renderTimeline(data, id) {
                                                                const timelineElement = document.getElementById(`timeline${id}`);
                                                                if (!timelineElement) {
                                                                    console.error("Timeline element not found");
                                                                    return;
                                                                }
                                                                timelineElement.innerHTML = '';
                                                                data.forEach((item) => {
                                                                    const timelineItem = createTimelineItem(item);
                                                                    timelineElement.appendChild(timelineItem);
                                                                });
                                                            }
                                                        
                                                            document.addEventListener("DOMContentLoaded", () => {
                                                                const leaveRequestId = "{{ request.id }}";
                                                                fetchLeaveRoutingData(leaveRequestId);
                                                            });
                                                        </script>

                                                      <hr>
                                                      <!-- details -->
                                                      <div class="container">
                                                        <div class="row">
                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Control Number</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"> <h6 class="body-regular light-gray fw-bold">{{request.id|stringformat:"05d"}}</h6></dd>

                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Leave Type</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"> <h6 class="body-regular light-gray fw-bold">{{request.leave_type}}</h6></dd>
                            
                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Start Date</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.from_date|date:'F d, Y'}}</h6></dd>
                            
                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">End Date</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.to_date|date:'F d, Y'}}</h6></dd>

                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">No of Days</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.days}}</h6></dd>
                            
                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">No of Hours</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.hrs}}</h6></dd>

                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Category</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.category.category_name}}</h6></dd>

                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Reason</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position"><h6 class="body-regular light-gray fw-bold">{{request.reason}}</h6></dd>

                                                            <dt class="col-sm-3 col-5"><h6 class="body-regular light-gray fw-medium">Status</h6></dt>
                                                            <dd class="col-sm-9 col-7 details-position">
                                                                {% if request.status == "Approved" %}
                                                                    <span class="status-badge status-approve">Approved</span>
                                                                {% elif request.status == "Disapproved" %}
                                                                    <span class="status-badge status-cancel">Disapproved</span>
                                                                {% else %}
                                                                    <span class="status-badge status-pending">On Process</span>
                                                                {% endif %}
                                                            </dd>
                                                        </div>
                                                        </div>
                                                        
                                                        <hr>
                                                        <!-- remarks -->
                                                        <div class="container">
                                                            <h6 class="offcanvas-title light-gray fw-bold">Remarks</h6>
                                                            {% for leave_routing in request.routings.all %}
                                                                {% if leave_routing.remarks %}
                                                                    <div class="p-2 my-2 border rounded-3">
                                                                        <p class="body-regular fw-bold light-gray">{{leave_routing.approver.name}}</p>
                                                                        <p class="dark-gray body-text">{{leave_routing.remarks}}</p>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                          </div> 
                                                    </div>
                                                  </div>


                                                <!-- cancel button -->
                                                <button class="button-light" type="button" data-bs-toggle="modal" data-bs-target="#Delete{{request.id}}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="#f3473b" class="bi bi-x action-icon" viewBox="0 0 16 16" stroke="#f3473b" stroke-width="2">
                                                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                                    </svg>
                                                </button>

                                                <!-- modal for deletion of leave -->
                                                <div class="modal fade" id="Delete{{request.id}}" tabindex="-1" aria-labelledby="Delete{{request.id}}Label" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                        <h4 class="modal-title light-gray" id="Delete{{request.id}}Label">Cancel Leave?</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="alert alert-danger" role="alert">
                                                                <p>Once you cancel a leave request, it will be taken out of the approval queue and will not be processed.</p>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="cancel-button" data-bs-dismiss="modal">Cancel</button>
                                                            <form method="POST" action="{% url 'delete-leave' pk=request.id %}">
                                                                {% csrf_token %}
                                                                <button type="submit" class="delete-button">Cancel Leave</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>   
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="no-filed-prf-container">      
                                <div><h5 class="light-gray">You haven't submitted any leave requests yet.</h5></div>
                                <img src="{% static 'images/empty-box.png' %}" alt="no data found">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</article>

<script>
    document.getElementById('leave_type').addEventListener('change', function() {
        const leaveTypeId = this.value;
        const categorySelect = document.getElementById('leave_category');
        
        categorySelect.innerHTML = '<option selected disabled value="">Choose...</option>';

        fetch(`/Leave/leave/get-categories/?leave_type_id=${leaveTypeId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.category_name;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching categories:', error));
    });

    (() => {
        'use strict'
      
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
          form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
      
            form.classList.add('was-validated')
          }, false)
        })
      })()
    
    document.addEventListener('DOMContentLoaded', function() {
        const durationSelect = document.getElementById('durationSelect');
        const underTimeInput = document.getElementById('underTimeInput');
        const noOfHrs = document.getElementById('no_of_hrs');
        const noOfDays = document.getElementById('no_of_days');
        const hiddenNoOfHrs = document.getElementById('hidden_no_of_hrs');
        const hiddenNoOfDays = document.getElementById('hidden_no_of_days');
        const halfDayOption = durationSelect.querySelector('option[value="Half Day"]');
        const underTimeOption = durationSelect.querySelector('option[value="Under Time"]');
        
        let initialHours = 8; // Default to 8 hours for one day
        
        function toggleDurationOptions() {
            const days = parseInt(noOfDays.textContent, 10);
            
            if (days === 1) {
                halfDayOption.classList.remove('d-none');
                underTimeOption.classList.remove('d-none');
            } else {
                halfDayOption.classList.add('d-none');
                underTimeOption.classList.add('d-none');
                
                // Reset to Full Day if currently on Half Day or Under Time
                if (durationSelect.value === 'Half Day' || durationSelect.value === 'Under Time') {
                    durationSelect.value = 'Full Day';
                    toggleUnderTimeInput();
                    updateHours();
                }
            }
        }
        
        function toggleUnderTimeInput() {
            if (durationSelect.value === 'Under Time') {
                underTimeInput.classList.remove('d-none');
                underTimeInput.classList.add('show');
                underTimeInput.focus();
            } else {
                underTimeInput.classList.add('d-none');
                underTimeInput.classList.remove('show');
                underTimeInput.value = '';
            }
        }

        function updateHiddenInputs() {
            hiddenNoOfDays.value = noOfDays.textContent;
            hiddenNoOfHrs.value = noOfHrs.textContent;
        }
        
        function updateHours() {
            initialHours = parseFloat(noOfHrs.textContent);
            
            if (durationSelect.value === 'Under Time') {
                if (underTimeInput.value) {
                    noOfHrs.textContent = underTimeInput.value;
                    hiddenNoOfHrs.value = underTimeInput.value;
                }
            } else if (durationSelect.value === 'Half Day') {
                noOfHrs.textContent = (initialHours / 2).toString();
                hiddenNoOfHrs.value = (initialHours / 2).toString();
            } else {
                noOfHrs.textContent = initialHours.toString();
                hiddenNoOfHrs.value = initialHours.toString();
            }
        }
        
        durationSelect.addEventListener('change', function() {
            toggleUnderTimeInput();
            updateHours();
            updateHiddenInputs()
        });
        
        underTimeInput.addEventListener('input', updateHours);
        
        // Initial setup
        toggleDurationOptions();
        toggleUnderTimeInput();
        
        // Observe changes to noOfDays
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    toggleDurationOptions();
                    updateHours();
                    updateHiddenInputs()
                }
            });
        });
        
        observer.observe(noOfDays, { childList: true });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const leaveFrom = document.getElementById('leaveFrom');
        const leaveTo = document.getElementById('leaveTo');
        const numberOfDaysDisplay = document.getElementById('no_of_days');
        const numberOfHrsDisplay = document.getElementById('no_of_hrs');
    
        const inputDays = document.getElementById('hidden_no_of_days');
        const inputHrs = document.getElementById('hidden_no_of_hrs');
        
        async function calculateLeaveDays() {
            if (!leaveFrom.value || !leaveTo.value) {
                numberOfDaysDisplay.textContent = '0';
                numberOfHrsDisplay.textContent = '0';
                inputDays.value = '0';
                inputHrs.value = '0';
                return;
            }
            
            try {
                const response = await fetch('/Leave/api/calculate-leave-days/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({
                        start_date: leaveFrom.value,
                        end_date: leaveTo.value,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.error) {
                    console.error('Error:', data.error);
                    numberOfDaysDisplay.textContent = '0';
                    numberOfHrsDisplay.textContent = '0';
                    inputDays.value = '0';
                    inputHrs.value = '0';
                } else {
                    numberOfDaysDisplay.textContent = data.working_days;
                    numberOfHrsDisplay.textContent = data.working_days * 8;
                    inputDays.value = data.working_days;
                    inputHrs.value = data.working_days * 8;
                }
            } catch (error) {
                console.error('Error calculating leave days:', error);
                numberOfDaysDisplay.textContent = '0';
                numberOfHrsDisplay.textContent = '0';
                inputDays.value = '0';
                inputHrs.value = '0';
            }
        }
        
        leaveFrom.addEventListener('change', calculateLeaveDays);
        leaveTo.addEventListener('change', calculateLeaveDays);
        
        // Validate end date is not before start date
        leaveTo.addEventListener('change', function() {
            if (leaveFrom.value && leaveTo.value < leaveFrom.value) {
                alert('End date cannot be before start date');
                leaveTo.value = leaveFrom.value;
            }
            calculateLeaveDays();
        });
    });
    
    function getCsrfToken() {
        const csrfCookie = document.cookie
            .split(';')
            .find(cookie => cookie.trim().startsWith('csrftoken='));
        return csrfCookie ? csrfCookie.split('=')[1] : null;
    }
</script>

{% endblock content %}